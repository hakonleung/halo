# 需求文档：目标管理模块

## 1. 背景与痛点

### 背景
NEO-LOG 是一个 AI 驱动的个人生活追踪系统，目前已经实现了行为记录、历史记录、可视化等核心功能。用户需要能够设定和管理目标，将行为记录与目标关联，并追踪目标的完成进度。

### 痛点
1. **缺乏目标管理界面**：虽然数据库 schema 中已有 `neolog_goals` 表，但缺少完整的前端界面和 API 路由
2. **目标与行为记录未关联**：无法将行为记录与目标关联，无法自动计算目标进度
3. **缺少目标进度可视化**：虽然有 `GoalProgressSection` 组件，但功能可能不完整
4. **缺少目标管理页面**：用户无法查看、编辑、管理自己的目标列表

### 现有基础
- ✅ 数据库表 `neolog_goals` 已存在
- ✅ `goal-service.ts` 已实现基础 CRUD
- ✅ 类型定义 `goal-client.ts` 和 `goal-server.ts` 已存在
- ✅ Dashboard 中有 `GoalProgressSection` 组件
- ❌ 缺少 API 路由 (`/api/goals`)
- ❌ 缺少前端页面 (`/goals`)
- ❌ 缺少 React Hooks (`use-goals.ts`)
- ❌ 缺少目标管理界面

## 2. 用户定义

| 用户角色 | 描述 | 使用场景 |
|---------|------|---------|
| 普通用户 | 希望追踪生活数据并设定目标的个人用户 | 创建目标、查看进度、更新目标状态 |

## 3. 功能范围

### Must Have (必须实现)

1. **目标 CRUD API**
   - `GET /api/goals` - 获取用户所有目标
   - `POST /api/goals` - 创建新目标
   - `PATCH /api/goals/[id]` - 更新目标
   - `DELETE /api/goals/[id]` - 删除目标

2. **目标管理页面**
   - 目标列表页面 (`/goals`)
   - 目标创建/编辑表单
   - 目标详情展示
   - 目标状态管理（active/completed/abandoned）

3. **目标进度计算**
   - 根据关联的行为记录自动计算目标进度
   - 支持多种达成条件（count, sum, avg 等）
   - 支持不同周期（daily, weekly, monthly）

4. **React Hooks**
   - `use-goals.ts` - 目标数据获取和操作
   - 集成 TanStack Query

5. **目标组件**
   - 目标列表组件
   - 目标表单组件
   - 目标进度展示组件（增强现有 `GoalProgressSection`）

### Nice to Have (可选实现)

1. **目标提醒功能**
   - 基于用户设置的目标提醒
   - 进度落后提醒

2. **目标分析**
   - 目标完成率统计
   - 目标趋势分析

3. **目标模板**
   - 预设目标模板
   - 快速创建常用目标

### 不做 (Out of Scope)

1. **目标分享功能** - 不在本次范围
2. **目标协作** - 不在本次范围
3. **目标导入/导出** - 不在本次范围
4. **目标 AI 建议** - 不在本次范围（Chatbot 模块已有）

## 4. 使用场景

### 场景 1：创建新目标
1. 用户进入 `/goals` 页面
2. 点击"创建目标"按钮
3. 填写目标信息（名称、描述、分类、开始日期、结束日期）
4. 设置达成条件（关联行为、指标、目标值、周期）
5. 保存目标

### 场景 2：查看目标列表
1. 用户进入 `/goals` 页面
2. 查看所有目标（按状态筛选：active/completed/abandoned）
3. 查看每个目标的基本信息和进度
4. 点击目标查看详情

### 场景 3：更新目标进度
1. 系统根据行为记录自动计算目标进度
2. 用户查看目标详情时看到最新进度
3. 当目标达成时，系统自动更新状态为 `completed`

### 场景 4：编辑/删除目标
1. 用户在目标列表中点击"编辑"
2. 修改目标信息
3. 保存更改
4. 或点击"删除"确认删除目标

## 5. 边界条件

1. **数据验证**
   - 目标名称必填，最大长度 100 字符
   - 开始日期必填，不能晚于结束日期
   - 达成条件至少一个
   - 目标值必须为正数

2. **权限控制**
   - 用户只能查看/编辑/删除自己的目标
   - 通过 RLS (Row Level Security) 实现

3. **性能要求**
   - 目标列表加载时间 < 500ms
   - 目标进度计算时间 < 200ms

4. **数据限制**
   - 单个用户最多 100 个活跃目标
   - 目标名称唯一性（同一用户）

5. **状态流转**
   - `active` → `completed` (自动或手动)
   - `active` → `abandoned` (手动)
   - `completed` / `abandoned` → `active` (手动恢复)

## 6. 成功指标

1. **功能完整性**
   - ✅ 所有 Must Have 功能实现率 = 100%
   - ✅ API 路由覆盖率 = 100%
   - ✅ 前端页面功能覆盖率 = 100%

2. **代码质量**
   - ✅ TypeScript 类型错误 = 0
   - ✅ ESLint 错误 = 0
   - ✅ 测试覆盖率 ≥ 80%

3. **用户体验**
   - ✅ 目标创建成功率 ≥ 95%
   - ✅ 页面加载时间 < 1s
   - ✅ 目标进度计算准确率 = 100%

4. **AI 验收通过率**
   - ✅ AI 自验收通过后自动进入下一阶段（无需人工确认）

## 7. 约束与假设

### 技术约束
- 使用 Next.js App Router
- 使用 TanStack Query 进行数据获取
- 使用 Chakra UI 组件库
- 遵循项目现有的代码规范和架构模式

### 业务假设
1. 目标与行为记录通过 `criteria` 字段中的 `behaviorId` 关联
2. 目标进度计算基于行为记录的 `recorded_at` 时间
3. 用户主要通过 Web 界面管理目标（移动端适配后续考虑）

### 依赖关系
- 依赖现有的 `neolog_behavior_records` 表
- 依赖现有的 `neolog_behavior_definitions` 表
- 依赖现有的认证系统

### 已知限制
- 目标进度计算可能涉及大量数据，需要考虑性能优化
- 目标达成条件的复杂性可能影响计算逻辑

