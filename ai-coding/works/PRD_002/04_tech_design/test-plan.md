# 测试计划：目标管理模块

## 1. 测试策略

### 1.1 测试左移
- 在技术设计阶段制定测试计划
- 在实现阶段同步编写测试
- 测试未通过禁止继续

### 1.2 测试层级
- **单元测试**: 工具函数、Service 层
- **集成测试**: API 路由、数据库交互
- **组件测试**: React 组件
- **E2E 测试**: 完整用户流程

### 1.3 覆盖率目标
- 单元测试覆盖率: ≥ 80%
- 集成测试覆盖率: ≥ 70%
- 组件测试覆盖率: ≥ 60%

## 2. 单元测试

### 2.1 goal-service.test.ts

**测试用例**:
- [ ] `getGoals()` - 获取目标列表
  - 正常情况：返回用户的所有目标
  - 筛选：按状态筛选
  - 筛选：按分类筛选
  - 排序：按创建时间排序
  - 排序：按进度排序
  - 错误：用户未认证
- [ ] `getGoal(id)` - 获取单个目标
  - 正常情况：返回目标详情
  - 错误：目标不存在
  - 错误：目标不属于当前用户
- [ ] `createGoal()` - 创建目标
  - 正常情况：创建成功
  - 验证：目标名称必填
  - 验证：目标名称最大 100 字符
  - 验证：开始日期必填
  - 验证：结束日期必须 ≥ 开始日期
  - 验证：达成条件至少一个
  - 错误：用户未认证
- [ ] `updateGoal()` - 更新目标
  - 正常情况：更新成功
  - 验证：同创建目标
  - 错误：目标不存在
  - 错误：目标不属于当前用户
- [ ] `deleteGoal()` - 删除目标
  - 正常情况：删除成功
  - 错误：目标不存在
  - 错误：目标不属于当前用户

### 2.2 goal-progress-service.test.ts

**测试用例**:
- [ ] `calculateProgress()` - 计算目标进度
  - **count 指标**:
    - daily: 计算每日记录数
    - weekly: 计算每周记录数
    - monthly: 计算每月记录数
  - **sum 指标**:
    - daily: 计算每日总和
    - weekly: 计算每周总和
    - monthly: 计算每月总和
  - **avg 指标**:
    - daily: 计算每日平均值
    - weekly: 计算每周平均值
    - monthly: 计算每月平均值
  - **运算符**:
    - `>`: 当前值 > 目标值
    - `>=`: 当前值 >= 目标值
    - `<`: 当前值 < 目标值
    - `<=`: 当前值 <= 目标值
    - `==`: 当前值 == 目标值
  - **进度计算**:
    - 当前值 = 0: 进度 = 0%
    - 当前值 = 目标值: 进度 = 100%
    - 当前值 > 目标值: 进度 = 100%
    - 当前值 < 目标值: 进度 = (当前值 / 目标值) * 100%
  - **完成判断**:
    - 当前值 >= 目标值: isCompleted = true
    - 当前值 < 目标值: isCompleted = false
  - **边界条件**:
    - 无行为记录: 进度 = 0%
    - 时间范围为空: 进度 = 0%
    - 多个达成条件: 取最小值

### 2.3 类型测试 (05a 阶段)

**测试用例**:
- [ ] Client ↔ Server 类型转换
  - GoalCriteria: behaviorId ↔ behavior_id
  - Goal: 字段名转换
  - Date ↔ ISO string 转换
- [ ] 类型验证
  - GoalCreateRequest 必填字段
  - GoalCriteria 字段类型

## 3. 集成测试

### 3.1 API 路由测试

**GET /api/goals**:
- [ ] 正常情况：返回目标列表
- [ ] 筛选：按状态筛选
- [ ] 筛选：按分类筛选
- [ ] 排序：按创建时间排序
- [ ] 错误：未认证返回 401

**POST /api/goals**:
- [ ] 正常情况：创建目标成功
- [ ] 验证：数据验证失败返回 400
- [ ] 错误：未认证返回 401

**GET /api/goals/[id]**:
- [ ] 正常情况：返回目标详情
- [ ] 错误：目标不存在返回 404
- [ ] 错误：未认证返回 401

**PATCH /api/goals/[id]**:
- [ ] 正常情况：更新目标成功
- [ ] 验证：数据验证失败返回 400
- [ ] 错误：目标不存在返回 404
- [ ] 错误：未认证返回 401

**DELETE /api/goals/[id]**:
- [ ] 正常情况：删除目标成功
- [ ] 错误：目标不存在返回 404
- [ ] 错误：未认证返回 401

## 4. 组件测试

### 4.1 goal-list.test.tsx

**测试用例**:
- [ ] 渲染：显示目标列表
- [ ] 加载状态：显示 Skeleton
- [ ] 空状态：显示空状态提示
- [ ] 错误状态：显示错误提示
- [ ] 筛选：按状态筛选
- [ ] 排序：按创建时间排序
- [ ] 点击：点击目标卡片导航到详情页

### 4.2 goal-card.test.tsx

**测试用例**:
- [ ] 渲染：显示目标信息
- [ ] 状态变体：active/completed/abandoned
- [ ] 进度显示：显示进度环和百分比
- [ ] 点击：点击卡片触发 onClick

### 4.3 goal-form.test.tsx

**测试用例**:
- [ ] 渲染：显示表单
- [ ] 验证：目标名称必填
- [ ] 验证：目标名称最大 100 字符
- [ ] 验证：开始日期必填
- [ ] 验证：结束日期必须 ≥ 开始日期
- [ ] 验证：达成条件至少一个
- [ ] 提交：提交表单调用 onSubmit
- [ ] 取消：取消调用 onCancel
- [ ] 编辑模式：预填充现有数据

### 4.4 use-goals.test.ts

**测试用例**:
- [ ] `useGoals()`: 获取目标列表
- [ ] `useGoal(id)`: 获取单个目标
- [ ] `useCreateGoal()`: 创建目标
- [ ] `useUpdateGoal()`: 更新目标
- [ ] `useDeleteGoal()`: 删除目标
- [ ] 缓存：更新后自动刷新缓存
- [ ] 错误处理：显示错误提示

## 5. E2E 测试

### 5.1 创建目标流程

```gherkin
Scenario: 用户创建目标
  Given 用户已登录
  When 用户进入 /goals 页面
  And 用户点击"创建目标"按钮
  And 用户填写目标信息
  And 用户设置达成条件
  And 用户点击"保存"按钮
  Then 目标创建成功
  And 目标出现在列表中
```

### 5.2 查看目标列表

```gherkin
Scenario: 用户查看目标列表
  Given 用户已登录
  And 用户有多个目标
  When 用户进入 /goals 页面
  Then 显示所有目标
  And 每个目标显示基本信息
  And 每个目标显示进度
```

### 5.3 查看目标详情

```gherkin
Scenario: 用户查看目标详情
  Given 用户已登录
  And 用户有一个目标
  When 用户点击目标卡片
  Then 显示目标详情页面
  And 显示目标的所有信息
  And 显示目标进度
  And 显示达成条件
  And 显示关联的行为记录
```

### 5.4 编辑目标

```gherkin
Scenario: 用户编辑目标
  Given 用户已登录
  And 用户有一个目标
  When 用户进入目标详情页面
  And 用户点击"编辑"按钮
  And 用户修改目标信息
  And 用户点击"保存"按钮
  Then 目标更新成功
  And 目标信息已更新
```

### 5.5 删除目标

```gherkin
Scenario: 用户删除目标
  Given 用户已登录
  And 用户有一个目标
  When 用户进入目标详情页面
  And 用户点击"删除"按钮
  And 用户确认删除
  Then 目标删除成功
  And 目标从列表中移除
```

### 5.6 目标进度计算

```gherkin
Scenario: 系统自动计算目标进度
  Given 用户已登录
  And 用户有一个目标
  And 目标关联的行为有记录
  When 用户查看目标详情
  Then 显示正确的进度
  And 进度百分比正确
  And 当前值/目标值正确
```

## 6. 性能测试

### 6.1 目标列表加载

- [ ] 10 个目标: 加载时间 < 200ms
- [ ] 50 个目标: 加载时间 < 500ms
- [ ] 100 个目标: 加载时间 < 1000ms

### 6.2 目标进度计算

- [ ] 单个目标: 计算时间 < 200ms
- [ ] 10 个目标: 批量计算时间 < 1000ms
- [ ] 100 个行为记录: 计算时间 < 200ms

### 6.3 页面加载

- [ ] 目标列表页面: 加载时间 < 1s
- [ ] 目标详情页面: 加载时间 < 1s

## 7. 安全测试

### 7.1 权限控制

- [ ] 用户只能查看自己的目标
- [ ] 用户只能编辑自己的目标
- [ ] 用户只能删除自己的目标
- [ ] 未认证用户无法访问 API

### 7.2 数据验证

- [ ] SQL 注入防护
- [ ] XSS 防护
- [ ] 输入数据验证

## 8. 测试工具

### 8.1 单元测试
- **框架**: Vitest
- **断言**: @testing-library/jest-dom

### 8.2 组件测试
- **框架**: Vitest + React Testing Library
- **渲染**: @testing-library/react

### 8.3 E2E 测试
- **框架**: Playwright
- **浏览器**: Chromium

### 8.4 性能测试
- **工具**: Lighthouse
- **指标**: FCP, LCP, TTI

## 9. 测试数据

### 9.1 测试用户
- 用户 ID: `test-user-1`
- 认证 Token: `test-token-1`

### 9.2 测试目标
- 目标 ID: `test-goal-1`
- 目标名称: "测试目标"
- 分类: "health"
- 状态: "active"

### 9.3 测试行为记录
- 行为定义 ID: `test-behavior-1`
- 记录数量: 100 条
- 时间范围: 最近 30 天

## 10. 测试执行计划

### 10.1 阶段 05a
- [ ] 类型测试
- [ ] 准备测试环境

### 10.2 阶段 05b
- [ ] goal-service 单元测试
- [ ] goal-progress-service 单元测试
- [ ] API 路由集成测试

### 10.3 阶段 05c
- [ ] use-goals Hook 测试
- [ ] 组件测试
- [ ] 页面测试

### 10.4 阶段 06
- [ ] E2E 测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 回归测试

